<template>
	<section class="my-12 bg-white">
		<div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="lg:text-center">
				<p class="text-base leading-6 text-indigo-600 font-semibold tracking-wide uppercase">
					{{ fields.preHeader }}
				</p>
				<h3 class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl sm:leading-10">
					{{ fields.title }}
				</h3>
				<p class="mt-4 max-w-2xl text-xl leading-7 text-gray-500 lg:mx-auto">
					{{ fields.subtitle }}
				</p>
			</div>

			<div class="mt-10">
				<ul class="md:grid md:grid-cols-2 md:gap-x-8 md:gap-y-10">
					<li v-for="post in posts" :key="post.contentID">
						<NuxtLink class="flex" :to="`/blog/${post.fields.slug}`">
							<div class="flex-shrink-0">
								<div class="flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
									<img
										class="h-12 w-12 rounded-md"
										:src="`${post.fields.image.url}?w=50&h=50`"
										:alt="post.fields.image.label"
										loading="lazy"
									/>
								</div>
							</div>
							<div class="ml-4">
								<h4 class="text-lg leading-6 font-medium text-gray-900">
									{{ post.fields.title }}
								</h4>
								<p class="mt-2 text-base leading-6 text-gray-500">
									{{ post.excerpt }}
								</p>
							</div>
						</NuxtLink>
					</li>
				</ul>
			</div>
		</div>
	</section>
</template>

<script>
const truncate = require("truncate-html");

export default {
	data: function() {
		return {
			posts: [],
		};
	},
	props: {
		contentID: Number,
		item: Object,
		page: Object,
		pageInSitemap: Object,
		dynamicPageItem: Object,
	},
	computed: {
		fields: function() {
			return this.item.fields;
		},
	},
	methods: {
		truncateText(text, length, clamp) {
			clamp = clamp || "...";
			var node = document.createElement("div");
			node.innerHTML = text;
			var content = node.textContent;
			return content.length > length ? content.slice(0, length) + clamp : content;
		},
	},
	async fetch() {
		let posts = [];
		const languageCode = this.$agility.languages[0];

		try {
			//get the global header

			if (process.server) {
				const postsRet = await this.$agility.client.getContentList({
					referenceName: "posts",
					languageCode,
				});
				posts = postsRet.map((p) => {
					p.excerpt = truncate(p.fields.content, {
						length: 160,
						decodeEntities: true,
						stripTags: true,
						reserveLastWord: true,
					});
					return p;
				});

			} else {
				const postsResClient = await this.$agility.client.getContentList({
					referenceName: "posts",
					languageCode,
				});

				posts = postsResClient.items.map((p) => {
					p.excerpt = this.truncateText(p.fields.content, 160);
					return p;
				});

			}


		} catch (error) {
			if (console) console.error("Could not load posts list.", error);
		}

		this.posts = posts;
	},
};
</script>
